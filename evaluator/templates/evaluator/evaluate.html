{% extends 'evaluator/base.html' %}

{% block content %}
<div class="container-fluid px-2 px-lg-4 mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-11">
            <!-- Completion Message (hidden by default) -->
            <div id="completionMessage" class="card shadow-lg border-0 d-none">
                <div class="card-body text-center py-5">
                    <h4 class="fs-3 text-success mb-3"><i class="bi bi-check-circle-fill"></i> All Done!</h4>
                    <p class="lead mb-4">You have evaluated all available images. Thank you for your contribution!</p>
                    <a href="{% url 'home' %}" class="btn btn-primary btn-lg">Return to Home</a>
                </div>
            </div>

            <!-- Main Evaluation Card -->
            <div id="evaluationContainer" class="card shadow-lg border-0 overflow-hidden" style="max-height: 85vh;">
                <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-clipboard-check me-2"></i>Image Evaluation
                    </h5>
                    <div id="progressInfo" class="badge bg-light text-dark border fs-6">Loading...</div>
                </div>
                
                <div class="row g-0 h-100">
                    <!-- Image Display Column -->
                    <div class="col-lg-8 bg-dark position-relative d-flex flex-column justify-content-center" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">
                        <div class="image-viewer w-100" id="imageViewer">
                            <img src="{{ image_url }}" 
                                 id="medicalImage"
                                 class="img-fluid" 
                                 alt="Medical Image" 
                                 draggable="false"
                                 style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: none; transition: none; user-select: none;">
                        </div>
                        <div class="position-absolute bottom-0 start-0 w-100 p-2 text-center text-white-50 bg-black bg-opacity-25 pointer-events-none">
                            <small><i class="bi bi-arrows-move"></i> Drag • <i class="bi bi-arrow-down-up"></i> Zoom • <i class="bi bi-arrows-collapse"></i> Dbl-Click Reset</small>
                        </div>
                    </div>

                    <!-- Evaluation Form Column -->
                    <div class="col-lg-4 bg-white border-start">
                        <div class="h-100 d-flex flex-column">
                            <div class="p-4 flex-grow-1 overflow-auto custom-scrollbar">
                                <div class="mb-4">
                                    <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.75rem; letter-spacing: 1px;">Assessment</h6>
                                    <form id="evaluationForm">
                                        {% csrf_token %}
                                        <input type="hidden" id="imagePath" value="{{ image_path }}">
                                        
                                        <!-- Image Type Selection -->
                                        <div class="mb-4">
                                            <label class="form-label fw-bold mb-2 small text-dark">
                                                Classification
                                            </label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="is_real" id="is_real_true" value="true" required>
                                                <label class="btn btn-outline-primary py-2" for="is_real_true">
                                                    <i class="bi bi-camera me-1"></i> Real
                                                </label>
                                                <input type="radio" class="btn-check" name="is_real" id="is_real_false" value="false" required>
                                                <label class="btn btn-outline-primary py-2" for="is_real_false">
                                                    <i class="bi bi-cpu me-1"></i> Synthetic
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Confidence Rating -->
                                        <div class="mb-4">
                                            <label class="form-label fw-bold mb-2 small text-dark">
                                                Confidence Level
                                            </label>
                                            <div class="confidence-selector d-flex flex-column gap-2">
                                                <div class="form-check p-0 m-0">
                                                    <input class="btn-check" type="radio" name="confidence" id="confidence_1" value="1" required>
                                                    <label class="btn btn-outline-light text-dark w-100 text-start border d-flex align-items-center p-2 hover-bg-light" for="confidence_1">
                                                        <span class="badge bg-danger rounded-pill me-2">1</span>
                                                        <span class="small">Very Low</span>
                                                    </label>
                                                </div>
                                                <div class="form-check p-0 m-0">
                                                    <input class="btn-check" type="radio" name="confidence" id="confidence_2" value="2" required>
                                                    <label class="btn btn-outline-light text-dark w-100 text-start border d-flex align-items-center p-2 hover-bg-light" for="confidence_2">
                                                        <span class="badge bg-warning text-dark rounded-pill me-2">2</span>
                                                        <span class="small">Low</span>
                                                    </label>
                                                </div>
                                                <div class="form-check p-0 m-0">
                                                    <input class="btn-check" type="radio" name="confidence" id="confidence_3" value="3" required>
                                                    <label class="btn btn-outline-light text-dark w-100 text-start border d-flex align-items-center p-2 hover-bg-light" for="confidence_3">
                                                        <span class="badge bg-info text-dark rounded-pill me-2">3</span>
                                                        <span class="small">Moderate</span>
                                                    </label>
                                                </div>
                                                <div class="form-check p-0 m-0">
                                                    <input class="btn-check" type="radio" name="confidence" id="confidence_4" value="4" required>
                                                    <label class="btn btn-outline-light text-dark w-100 text-start border d-flex align-items-center p-2 hover-bg-light" for="confidence_4">
                                                        <span class="badge bg-success rounded-pill me-2">4</span>
                                                        <span class="small">High</span>
                                                    </label>
                                                </div>
                                                <div class="form-check p-0 m-0">
                                                    <input class="btn-check" type="radio" name="confidence" id="confidence_5" value="5" required>
                                                    <label class="btn btn-outline-light text-dark w-100 text-start border d-flex align-items-center p-2 hover-bg-light" for="confidence_5">
                                                        <span class="badge bg-primary rounded-pill me-2">5</span>
                                                        <span class="small">Very High</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Submit -->
                                        <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm" id="submitBtn">
                                            Submit Evaluation
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="p-3 bg-light border-top text-center">
                                <small class="text-muted" style="font-size: 0.70rem;">
                                    <i class="bi bi-shield-lock"></i> Secure Evaluation
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* New Card Layout Styles */
.hover-bg-light:hover {
    background-color: #f8f9fa !important;
    border-color: #dee2e6 !important;
}

.btn-check:checked + .btn-outline-light {
    background-color: #e7f3ff;
    border-color: #0d6efd !important;
    color: #0d6efd !important;
}

.btn-check:checked + .btn-outline-light .badge {
    box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
}

.image-viewer {
    background: transparent;
    width: 100%;
    height: 65vh; 
    min-height: 400px;
    max-height: 800px;
    overflow: hidden;
    position: relative;
    cursor: grab;
    /* Center fallback */
    display: flex;
    justify-content: center;
    align-items: center;
}

.image-viewer:active {
    cursor: grabbing !important;
}

.image-viewer img {
    cursor: inherit;
}

.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent; 
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #d1d5db; 
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #9ca3af; 
}

.pointer-events-none {
    pointer-events: none;
}

/* Base Styles adjustments */
.card {
    border-radius: 0.75rem;
}

/* Mobile responsive adjustments */
@media (max-width: 991px) {
    .image-viewer {
        height: 50vh;
        min-height: 300px;
    }
    
    #evaluationContainer .row {
        height: auto !important;
    }
    
    #evaluationContainer {
        height: auto !important;
        max-height: none !important;
    }

    .col-lg-4.border-start {
        border-left: 0 !important;
        border-top: 1px solid #dee2e6 !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('evaluationForm');
    const submitBtn = document.getElementById('submitBtn');
    const medicalImage = document.getElementById('medicalImage');
    const imageViewer = document.getElementById('imageViewer');
    const progressInfo = document.getElementById('progressInfo');
    const completionMessage = document.getElementById('completionMessage');
    const evaluationContainer = document.getElementById('evaluationContainer');
    
    // Map-like image viewer
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialTranslateX = 0;
    let initialTranslateY = 0;
    
    // Touch support variables
    let initialDistance = 0;
    let initialScale = 1;
    
    function updateTransform() {
        medicalImage.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
    }
    
    function resetView() {
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
    }
    
    // Get distance between two touch points
    function getDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }
    
    // Mouse wheel zoom (like Google Maps)
    imageViewer.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        const rect = imageViewer.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Calculate zoom
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.5, Math.min(5, scale * delta));
        
        // Zoom towards mouse position
        const scaleChange = newScale / scale;
        const viewerCenterX = rect.width / 2;
        const viewerCenterY = rect.height / 2;
        
        translateX = (translateX - (mouseX - viewerCenterX)) * scaleChange + (mouseX - viewerCenterX);
        translateY = (translateY - (mouseY - viewerCenterY)) * scaleChange + (mouseY - viewerCenterY);
        scale = newScale;
        
        updateTransform();
    }, { passive: false });
    
    // Mouse drag to pan
    imageViewer.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialTranslateX = translateX;
        initialTranslateY = translateY;
        imageViewer.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        
        translateX = initialTranslateX + dx;
        translateY = initialTranslateY + dy;
        
        updateTransform();
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            imageViewer.style.cursor = 'grab';
        }
    });
    
    // Touch support for mobile
    imageViewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            // Single touch - pan
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            initialTranslateX = translateX;
            initialTranslateY = translateY;
        } else if (e.touches.length === 2) {
            // Two fingers - pinch zoom
            isDragging = false;
            initialDistance = getDistance(e.touches[0], e.touches[1]);
            initialScale = scale;
        }
    }, { passive: true });
    
    imageViewer.addEventListener('touchmove', (e) => {
        e.preventDefault();
        
        if (e.touches.length === 1 && isDragging) {
            // Single touch pan
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            
            translateX = initialTranslateX + dx;
            translateY = initialTranslateY + dy;
            
            updateTransform();
        } else if (e.touches.length === 2) {
            // Pinch zoom
            const currentDistance = getDistance(e.touches[0], e.touches[1]);
            const scaleChange = currentDistance / initialDistance;
            const newScale = Math.max(0.5, Math.min(5, initialScale * scaleChange));
            
            scale = newScale;
            updateTransform();
        }
    }, { passive: false });
    
    imageViewer.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) {
            isDragging = false;
        } else if (e.touches.length === 1) {
            // Reset for single touch after pinch
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            initialTranslateX = translateX;
            initialTranslateY = translateY;
        }
    }, { passive: true });
    
    // Double-click/tap to reset
    imageViewer.addEventListener('dblclick', () => {
        resetView();
    });
    
    let lastTap = 0;
    imageViewer.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
            resetView();
        }
        lastTap = currentTime;
    });
    
    // Prevent image dragging
    medicalImage.addEventListener('dragstart', (e) => {
        e.preventDefault();
    });
    
    // Form submission with Fetch API
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const isRealInput = document.querySelector('input[name="is_real"]:checked');
        const confidenceInput = document.querySelector('input[name="confidence"]:checked');
        
        if (!isRealInput || !confidenceInput) {
            alert('Please complete both the image classification and confidence level before submitting.');
            return;
        }
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        
        try {
            const response = await fetch('{% url "submit_evaluation" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    image_path: document.getElementById('imagePath').value,
                    is_real: isRealInput.value === 'true',
                    confidence: parseInt(confidenceInput.value)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Reset form and view
                form.reset();
                resetView();
                
                // Load next image
                await loadNextImage();
            } else {
                alert('Error submitting evaluation: ' + data.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Evaluation';
            }
        } catch (error) {
            alert('Network error. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Evaluation';
        }
    });
    
    async function loadNextImage() {
        try {
            const response = await fetch('{% url "get_next_image" %}');
            const data = await response.json();
            
            if (data.success) {
                if (data.completed) {
                    // Show completion message
                    evaluationContainer.classList.add('d-none');
                    completionMessage.classList.remove('d-none');
                    progressInfo.textContent = 'Completed!';
                } else {
                    // Load new image
                    medicalImage.src = data.image_url;
                    document.getElementById('imagePath').value = data.image_path;
                    progressInfo.textContent = `${data.remaining} image${data.remaining !== 1 ? 's' : ''} remaining`;
                    
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Evaluation';
                }
            } else {
                alert('Error loading next image: ' + data.message);
            }
        } catch (error) {
            alert('Network error loading next image.');
        }
    }
    
    // Initialize progress info
    loadNextImage();
});
</script>
{% endblock %}
