{% extends 'evaluator/base.html' %}

{% block content %}
<div class="container-fluid px-2 px-lg-4 mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-11">
            <!-- Header -->
            <div class="text-center mb-3 mb-md-4">
                <h2 class="fw-bold text-primary fs-3 fs-md-2">
                    <i class="bi bi-clipboard-check"></i> Image Evaluation
                </h2>
                <p class="text-muted mb-2 small">Evaluate whether the medical image below is real or synthetically generated</p>
                <div id="progressInfo" class="badge bg-secondary fs-6">Loading...</div>
            </div>

            <!-- Completion Message (hidden by default) -->
            <div id="completionMessage" class="alert alert-success text-center d-none mx-2 mx-md-0">
                <h4 class="fs-5 fs-md-4"><i class="bi bi-check-circle-fill"></i> All Done!</h4>
                <p class="mb-3 small">You have evaluated all available images. Thank you for your contribution!</p>
                <a href="{% url 'home' %}" class="btn btn-primary">Return to Home</a>
            </div>

            <div id="evaluationContainer" class="row">
                <!-- Image Display Column -->
                <div class="col-12 col-lg-8 mb-4">
                    <div class="card shadow-lg border-0">
                        <div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h5 class="mb-0"><i class="bi bi-image"></i> Medical Image</h5>
                        </div>
                        <div class="card-body p-0 position-relative" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">
                            <div class="image-viewer" id="imageViewer">
                                <img src="{{ image_url }}" 
                                     id="medicalImage"
                                     class="img-fluid" 
                                     alt="Medical Image" 
                                     draggable="false"
                                     style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: none; transition: none; user-select: none;">
                            </div>
                        </div>
                        <div class="card-footer bg-light text-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> <strong>Drag</strong> to pan • <strong>Scroll</strong> to zoom • <strong>Double-click</strong> to reset
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Evaluation Form Column -->
                <div class="col-12 col-lg-4">
                    <div class="card shadow-lg border-0 evaluation-form-card">
                        <div class="card-header bg-primary text-white py-3">
                            <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Your Evaluation</h5>
                        </div>
                        <div class="card-body p-4">
                            <form id="evaluationForm">
                                {% csrf_token %}
                                <input type="hidden" id="imagePath" value="{{ image_path }}">
                                
                                <!-- Image Type Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold mb-3">
                                        <i class="bi bi-question-circle"></i> Image Classification
                                    </label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="is_real" id="is_real_true" value="true" required>
                                        <label class="btn btn-outline-primary btn-lg" for="is_real_true">
                                            <i class="bi bi-camera"></i> Real
                                        </label>
                                        <input type="radio" class="btn-check" name="is_real" id="is_real_false" value="false" required>
                                        <label class="btn btn-outline-primary btn-lg" for="is_real_false">
                                            <i class="bi bi-cpu"></i> Synthetic
                                        </label>
                                    </div>
                                </div>

                                <!-- Confidence Rating -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold mb-3">
                                        <i class="bi bi-speedometer"></i> Confidence Level
                                    </label>
                                    <div class="confidence-selector">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="confidence" id="confidence_1" value="1" required>
                                            <label class="form-check-label d-flex align-items-center w-100" for="confidence_1">
                                                <span class="confidence-badge me-3 badge bg-danger">1</span>
                                                <span class="confidence-text flex-grow-1">Very Low Confidence</span>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="confidence" id="confidence_2" value="2" required>
                                            <label class="form-check-label d-flex align-items-center w-100" for="confidence_2">
                                                <span class="confidence-badge me-3 badge bg-warning">2</span>
                                                <span class="confidence-text flex-grow-1">Low Confidence</span>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="confidence" id="confidence_3" value="3" required>
                                            <label class="form-check-label d-flex align-items-center w-100" for="confidence_3">
                                                <span class="confidence-badge me-3 badge bg-info">3</span>
                                                <span class="confidence-text flex-grow-1">Moderate Confidence</span>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="confidence" id="confidence_4" value="4" required>
                                            <label class="form-check-label d-flex align-items-center w-100" for="confidence_4">
                                                <span class="confidence-badge me-3 badge bg-success">4</span>
                                                <span class="confidence-text flex-grow-1">High Confidence</span>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="confidence" id="confidence_5" value="5" required>
                                            <label class="form-check-label d-flex align-items-center w-100" for="confidence_5">
                                                <span class="confidence-badge me-3 badge bg-primary">5</span>
                                                <span class="confidence-text flex-grow-1">Very High Confidence</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-success btn-lg shadow" id="submitBtn">
                                        <i class="bi bi-check-circle"></i> Submit Evaluation
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="card-footer bg-light text-center">
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i> Your evaluation will be saved securely
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.confidence-selector .form-check {
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.confidence-selector .form-check:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.confidence-selector .form-check-input:checked ~ .form-check-label {
    font-weight: 600;
}

.confidence-selector .form-check:has(.form-check-input:checked) {
    background-color: #e7f3ff;
    border-color: #0d6efd;
}

.confidence-badge {
    font-size: 1rem;
    padding: 0.35rem 0.65rem;
    min-width: 2.5rem;
    text-align: center;
}

.btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.card {
    border-radius: 0.75rem;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.image-viewer {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    width: 100%;
    height: 700px;
    overflow: hidden;
    position: relative;
    cursor: grab;
}

/* Mobile responsive */
@media (max-width: 991px) {
    .image-viewer {
        height: 500px;
    }
    
    .evaluation-form-card {
        position: relative !important;
        top: 0 !important;
    }
}

@media (max-width: 576px) {
    .image-viewer {
        height: 400px;
    }
}

/* Desktop sticky form */
@media (min-width: 992px) {
    .evaluation-form-card {
        position: sticky;
        top: 80px;
        /* Match total height of image card: 
           header (py-3) + image (700px) + footer 
           Total: approximately 778px */
        min-height: 800px;
        display: flex;
        flex-direction: column;
    }
    
    .evaluation-form-card .card-body {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .evaluation-form-card .card-body form {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
}

.image-viewer:active {
    cursor: grabbing !important;
}

.image-viewer img {
    cursor: inherit;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('evaluationForm');
    const submitBtn = document.getElementById('submitBtn');
    const medicalImage = document.getElementById('medicalImage');
    const imageViewer = document.getElementById('imageViewer');
    const progressInfo = document.getElementById('progressInfo');
    const completionMessage = document.getElementById('completionMessage');
    const evaluationContainer = document.getElementById('evaluationContainer');
    
    // Map-like image viewer
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialTranslateX = 0;
    let initialTranslateY = 0;
    
    // Touch support variables
    let initialDistance = 0;
    let initialScale = 1;
    
    function updateTransform() {
        medicalImage.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
    }
    
    function resetView() {
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
    }
    
    // Get distance between two touch points
    function getDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }
    
    // Mouse wheel zoom (like Google Maps)
    imageViewer.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        const rect = imageViewer.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Calculate zoom
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.5, Math.min(5, scale * delta));
        
        // Zoom towards mouse position
        const scaleChange = newScale / scale;
        const viewerCenterX = rect.width / 2;
        const viewerCenterY = rect.height / 2;
        
        translateX = (translateX - (mouseX - viewerCenterX)) * scaleChange + (mouseX - viewerCenterX);
        translateY = (translateY - (mouseY - viewerCenterY)) * scaleChange + (mouseY - viewerCenterY);
        scale = newScale;
        
        updateTransform();
    }, { passive: false });
    
    // Mouse drag to pan
    imageViewer.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialTranslateX = translateX;
        initialTranslateY = translateY;
        imageViewer.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        
        translateX = initialTranslateX + dx;
        translateY = initialTranslateY + dy;
        
        updateTransform();
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            imageViewer.style.cursor = 'grab';
        }
    });
    
    // Touch support for mobile
    imageViewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            // Single touch - pan
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            initialTranslateX = translateX;
            initialTranslateY = translateY;
        } else if (e.touches.length === 2) {
            // Two fingers - pinch zoom
            isDragging = false;
            initialDistance = getDistance(e.touches[0], e.touches[1]);
            initialScale = scale;
        }
    }, { passive: true });
    
    imageViewer.addEventListener('touchmove', (e) => {
        e.preventDefault();
        
        if (e.touches.length === 1 && isDragging) {
            // Single touch pan
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            
            translateX = initialTranslateX + dx;
            translateY = initialTranslateY + dy;
            
            updateTransform();
        } else if (e.touches.length === 2) {
            // Pinch zoom
            const currentDistance = getDistance(e.touches[0], e.touches[1]);
            const scaleChange = currentDistance / initialDistance;
            const newScale = Math.max(0.5, Math.min(5, initialScale * scaleChange));
            
            scale = newScale;
            updateTransform();
        }
    }, { passive: false });
    
    imageViewer.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) {
            isDragging = false;
        } else if (e.touches.length === 1) {
            // Reset for single touch after pinch
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            initialTranslateX = translateX;
            initialTranslateY = translateY;
        }
    }, { passive: true });
    
    // Double-click/tap to reset
    imageViewer.addEventListener('dblclick', () => {
        resetView();
    });
    
    let lastTap = 0;
    imageViewer.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
            resetView();
        }
        lastTap = currentTime;
    });
    
    // Prevent image dragging
    medicalImage.addEventListener('dragstart', (e) => {
        e.preventDefault();
    });
    
    // Form submission with Fetch API
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const isRealInput = document.querySelector('input[name="is_real"]:checked');
        const confidenceInput = document.querySelector('input[name="confidence"]:checked');
        
        if (!isRealInput || !confidenceInput) {
            alert('Please complete both the image classification and confidence level before submitting.');
            return;
        }
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        
        try {
            const response = await fetch('{% url "submit_evaluation" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    image_path: document.getElementById('imagePath').value,
                    is_real: isRealInput.value === 'true',
                    confidence: parseInt(confidenceInput.value)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Reset form and view
                form.reset();
                resetView();
                
                // Load next image
                await loadNextImage();
            } else {
                alert('Error submitting evaluation: ' + data.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Evaluation';
            }
        } catch (error) {
            alert('Network error. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Evaluation';
        }
    });
    
    async function loadNextImage() {
        try {
            const response = await fetch('{% url "get_next_image" %}');
            const data = await response.json();
            
            if (data.success) {
                if (data.completed) {
                    // Show completion message
                    evaluationContainer.classList.add('d-none');
                    completionMessage.classList.remove('d-none');
                    progressInfo.textContent = 'Completed!';
                } else {
                    // Load new image
                    medicalImage.src = data.image_url;
                    document.getElementById('imagePath').value = data.image_path;
                    progressInfo.textContent = `${data.remaining} image${data.remaining !== 1 ? 's' : ''} remaining`;
                    
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Evaluation';
                }
            } else {
                alert('Error loading next image: ' + data.message);
            }
        } catch (error) {
            alert('Network error loading next image.');
        }
    }
    
    // Initialize progress info
    loadNextImage();
});
</script>
{% endblock %}
